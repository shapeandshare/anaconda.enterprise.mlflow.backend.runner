name: anaconda.enterprise.mlflow.backend.runner

description: |
  This project is used as a template by the Anaconda Enterprise MLFlow Backend Plugin.
  Training jobs are spawned off this template.

variables:
  RUNNER_PERSISTENT_STORAGE: data
#  AE_HOSTNAME:
#  AE_USERNAME:
#  AE_AUTH:

commands:
  #
  # Run Time Commands
  #

  RunnerAPI:
    # TODO: migrate to default after initial develop is complete
    env_spec: default
    unix: python -m src.anaconda.enterprise.mlflow.backend.runner.handler --activity server
    supports_http_options: true

  Worker:
    # TODO: migrate to default after initial develop is complete
    env_spec: default
    unix: python -m src.anaconda.enterprise.mlflow.backend.runner.handler --activity worker

  #
  # Development Time Commands
  #

  bash:
    env_spec: default
    unix: bash

  test:unit:
    env_spec: default
    unix: coverage run --append --rcfile=.coveragerc -m unittest discover test/unit

  coverage:
    env_spec: default
    unix: |
      coverage report
      coverage html
      coverage xml

  test:integration:
    env_spec: default
    unix: python -m unittest discover test/integration

  clean:
    env_spec: default
    unix: |
      rm -rf .coverage htmlcov docs/build

  lint:
    env_spec: default
    unix: |
      pylint src
      isort --check --diff .
      black --line-length=120 --target-version=py310 --check --diff .

  lint:fix:
    env_spec: default
    unix: |
      isort .
      black --line-length=120 --target-version=py310 .

  build:docs:quickstart:
    env_spec: default
    unix: |
      sphinx-quickstart docs --sep --project anaconda.enterprise.mlflow.backend.runner

  build:apidocs:
    env_spec: default
    unix: |
      sphinx-apidoc -f -o docs/source/runner src/anaconda/enterprise/mlflow/backend/runner

  build:docs:
    env_spec: default
    unix: |
      rm -rf docs/build docs/runner && cp -rf src/anaconda/enterprise/mlflow/backend/runner docs && cd docs && make clean && make html


channels:
    - https://conda.anaconda.org/conda-forge/
    - https://conda.anaconda.org/joshburt/
    - https://conda.anaconda.org/ae5-admin

platforms:
  - linux-64
  - osx-64
  - osx-arm64
  - win-64

env_specs:
    default:
        description: Default Environment
        packages:
          - python=3.10
          - mlflow=2.0.1
          - ae5-tools
          - ipykernel
          - fastapi
          - uvicorn[standard]
          - anaconda.enterprise.server.common.sdk
          - anaconda.enterprise.server.contracts>=0.9.3
    development:
        description: Development Environment
        packages:
          - python=3.10
          - mlflow=2.0.1
          - ae5-tools
          - ipykernel
          - isort
          - black
          - black-jupyter
          - pylint
          - coverage
          - pyyaml
          - sphinx
          - sphinx-rtd-theme
          - myst-parser
          - jupyterlab
          - fastapi
          - uvicorn[standard]
          - anaconda.enterprise.server.common.sdk
          - anaconda.enterprise.server.contracts>=0.9.3
